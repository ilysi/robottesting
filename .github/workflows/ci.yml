name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      # run API tests (fast)
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Poetry
        uses: abatilo/actions-poetry@v2

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: 'pyproject.toml' # Read python version from a file pyproject.toml
          cache: 'poetry'

      - name: Install dependencies
        run: poetry install
      
      - name: Run Robot Framework tests
        run: poetry run robotcode robot --outputdir "results/api" tests/api_tests

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          path: results/api
          name: api-results
          retention-days: 7

  browser-tests:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      # run Browser tests with rfbrowser
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Poetry
        uses: abatilo/actions-poetry@v2

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: 'pyproject.toml' # Read python version from a file pyproject.toml
          cache: 'poetry'

      - name: Install dependencies
        run: poetry install

      - name: Setup Node.js environment
        uses: actions/setup-node@v5.0.0

      - name: Install browser dependencies # Required for Browser library
        run: poetry run rfbrowser init

      - name: Run Robot Framework tests
        run: poetry run robotcode robot --outputdir "results/browser"  tests/browser_tests

      - name: Upload browser test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          path: results/browser
          name: browser-results
          retention-days: 7

  mobile-tests:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      # run Appium + iOS Simulator tests
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Poetry
        uses: abatilo/actions-poetry@v2

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: 'pyproject.toml' # Read python version from a file pyproject.toml
          cache: 'poetry'

      - name: Install dependencies
        run: poetry install

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      # ---- iOS spezifisch ----
      - name: Install Node + Appium
        run: |
          brew install node
          npm install -g appium
          appium driver install xcuitest

      - name: Boot iOS Simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone 16 Pro'
          os_version: '18.6'
          erase_before_boot: 'false'
          wait_for_boot: 'true'
          shutdown_after_job: 'true'

      - name: Wait for Simulator to be fully booted
        run: |
          UDID=$(xcrun simctl list devices | grep 'iPhone 16 Pro' | grep -oE '[A-F0-9-]{36}')
          for i in {1..30}; do
            BOOTED=$(xcrun simctl list devices | grep "$UDID" | grep -c "(Booted)")
            if [ "$BOOTED" -eq 1 ]; then
              echo "Simulator is fully booted!"
              break
            fi
            echo "Waiting for simulator to boot..."
            sleep 2
          done

      - name: Start Appium server
        run: nohup appium --address 127.0.0.1 --port 4723 > appium.log 2>&1 &

      - name: Wait for Appium server to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:4723/status | grep -q '"ready":true'; then
              echo "Appium is ready!"
              break
            fi
            echo "Waiting for Appium to be ready..."
            sleep 2
          done

      - name: Run Robot Framework tests
        run: poetry run robotcode robot --outputdir "results/mobile" tests/mobile_tests

      - name: Upload Appium Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log

      - name: Upload Robot Framework results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          path: results/mobile
          name: mobile-results
          retention-days: 7
